#!/bin/bash

set -x
set -e

export GPUPACK_PREFIX=$HOME/gpupack

# Cycle & a branch

export CYCLE=49t2
export BRANCH=openacc
export REPO=https://github.com/pmarguinaud/IAL.git
export ECTRANS_GPU=OFF

# Architecture flavor

export OPT=1d

# Compiler

export ARCH=NVHPC2403

# Do everything and compile

export COMPILE=ON

# Do everything in screen session

export SCREEN=OFF

# gmkpack options subset

err=0

while getopts 'r:b:l:o:R:GNS' option
do
   case $option in
   r)  CYCLE=$OPTARG;;
   b)  BRANCH=$OPTARG;;
   l)  ARCH=$OPTARG;;
   o)  OPT=$OPTARG;;
   R)  REPO=$OPTARG;;
   G)  ECTRANS_GPU="ON";;
   N)  COMPILE="OFF";;
   S)  SCREEN="ON";;
   \?) err=1;;
   esac 
done

if [ $err -eq 1 ]
then
  exit 1
fi

cd $GPUPACK_PREFIX

if [ "$SCREEN" == "ON" ]
then

  init=$(mktemp --suffix .gpupack.sh)
  chmod 755 $init

  cat > $init << EOF
if [ -f ~/.bashrc ]
then
  source ~/.bashrc
fi
source "$GPUPACK_PREFIX/scripts/gpupack"

run_gpupack

EOF
  
  screen -S gpupack bash --rcfile $init -i

else 

  source "$GPUPACK_PREFIX/scripts/gpupack"
  run_gpupack

fi

