set  -euxv

#=======================================================================
#
#     Script ec_blacklist_generator
#     -----------------------------
#
#     Purpose     : Make blacklist file
#     -------
#
#     Usage       : ec_blacklist_generator > blacklist.b
#     -----
#
#     Parameters  : environment variables BLACK_DS, BLACK_MM, BLACK_EX,
#     ----------    BASETIME, WDIR, XDATA, IFS_CYCLE, DATA
#
#=======================================================================
set  +v


#=======================================================================
#   Fetch data selection, monthly monitoring and external specification
#   blacklist files
#=======================================================================

if [[ ${BLACK_DS} = ops ]] ; then
  get_ds_black  -d $BASETIME  -f $WDIR/bl_data_sel
else
  Ecp  -o  ec:${BLACK_DS}  $WDIR/bl_data_sel
fi
ln  -s $WDIR/bl_data_sel  bl_data_sel

if [[ ${BLACK_MM} = ops ]] ; then
  get_mm_black  -d $BASETIME  -f $WDIR/monthly_bl_mon_monit.b
  ln  -s $WDIR/monthly_bl_mon_monit.b  monthly_bl_mon_monit.b
else
  Ecp  -o  ec:${BLACK_MM}  $DATA/an/monthly_bl_mon_monit.b
  ln  -s $DATA/an/monthly_bl_mon_monit.b  monthly_bl_mon_monit.b
fi

if [[ ${BLACK_EX} = ops ]] ; then
  cp  $XDATA/${IFS_CYCLE}/an/external_bl_mon_monit.b external_bl_mon_monit.b
else
  Ecp  -o  ec:${BLACK_EX}  $DATA/an/external_bl_mon_monit.b
  cp  $DATA/an/external_bl_mon_monit.b  external_bl_mon_monit.b
fi

#=======================================================================
#   Generate blacklist C code
#=======================================================================

cat  >BLACKLIST.B  <<EOF
#include "external_bl_mon_monit.b"
#include "bl_data_sel"
#include "monthly_bl_mon_monit.b"
EOF
#
date=$( echo $BASETIME | cut -c1-8 )
hour=$( echo $BASETIME | cut -c9-10 )
#

cpp -P -DANDATE=$date -DANTIME=${hour}0000 BLACKLIST.B

\rm -f *.b *.B bl_data_sel

exit
